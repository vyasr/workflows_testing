name: Issue Release Field Automation

on:
  issues:
    types: [opened, edited]
  # Note: Projects V2 don't emit repository-level events when fields change.
  # For Priority changes made directly in the project view, consider adding
  # a scheduled workflow (see issue-release-scheduled.yml example)

jobs:
  update-release-field:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get issue project data and update release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const issueNumber = context.payload.issue?.number;

            if (!issueNumber) {
              console.log('No issue number found in context');
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`Processing issue #${issueNumber}`);

            try {
              // Read VERSION file to get current release
              const fs = require('fs');
              const versionContent = fs.readFileSync('VERSION', 'utf8').trim();
              const versionParts = versionContent.split('.');
              const currentRelease = `${versionParts[0]}.${versionParts[1]}`;
              console.log(`Current release from VERSION: ${currentRelease}`);

              // Get the issue's node ID
              const { data: issue } = await github.rest.issues.get({
                owner,
                repo,
                issue_number: issueNumber
              });

              const issueNodeId = issue.node_id;
              console.log(`Issue node ID: ${issueNodeId}`);

              // Query to get project items for this issue
              const projectItemsQuery = `
                query($nodeId: ID!) {
                  node(id: $nodeId) {
                    ... on Issue {
                      projectItems(first: 10) {
                        nodes {
                          id
                          project {
                            id
                            title
                          }
                          fieldValues(first: 20) {
                            nodes {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                name
                                field {
                                  ... on ProjectV2SingleSelectField {
                                    id
                                    name
                                  }
                                }
                              }
                              ... on ProjectV2ItemFieldTextValue {
                                text
                                field {
                                  ... on ProjectV2Field {
                                    id
                                    name
                                  }
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;

              const projectItemsResult = await github.graphql(projectItemsQuery, {
                nodeId: issueNodeId
              });

              const projectItems = projectItemsResult.node?.projectItems?.nodes || [];

              if (projectItems.length === 0) {
                console.log('Issue is not in any project, skipping');
                return;
              }

              // Process each project the issue is in
              for (const projectItem of projectItems) {
                const projectId = projectItem.project.id;
                const projectTitle = projectItem.project.title;
                const itemId = projectItem.id;

                console.log(`Processing project: ${projectTitle}`);

                // Find Priority and Release fields
                let priorityValue = null;
                let releaseFieldId = null;

                for (const fieldValue of projectItem.fieldValues.nodes) {
                  if (fieldValue.field?.name === 'Priority') {
                    priorityValue = fieldValue.name;
                    console.log(`Found Priority: ${priorityValue}`);
                  }
                  if (fieldValue.field?.name === 'Release') {
                    releaseFieldId = fieldValue.field.id;
                    console.log(`Found Release field ID: ${releaseFieldId}`);
                  }
                }

                // If we don't have Priority field, try to get the field ID anyway
                if (!releaseFieldId) {
                  console.log('Release field not found on item, querying project fields');

                  const projectFieldsQuery = `
                    query($projectId: ID!) {
                      node(id: $projectId) {
                        ... on ProjectV2 {
                          fields(first: 20) {
                            nodes {
                              ... on ProjectV2Field {
                                id
                                name
                              }
                              ... on ProjectV2SingleSelectField {
                                id
                                name
                                options {
                                  id
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  `;

                  const projectFieldsResult = await github.graphql(projectFieldsQuery, {
                    projectId: projectId
                  });

                  const fields = projectFieldsResult.node?.fields?.nodes || [];
                  const releaseField = fields.find(f => f.name === 'Release');
                  const priorityField = fields.find(f => f.name === 'Priority');

                  if (releaseField) {
                    releaseFieldId = releaseField.id;
                    console.log(`Found Release field ID from project: ${releaseFieldId}`);
                  }

                  // If Priority value wasn't found in item, we can't proceed
                  if (!priorityValue && priorityField) {
                    console.log('Priority field exists but has no value on this item');
                  }
                }

                if (!priorityValue) {
                  console.log('No Priority field value found, skipping this project');
                  continue;
                }

                if (!releaseFieldId) {
                  await github.rest.issues.createComment({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    body: `⚠️ **Release Automation**: Could not find Release field in project "${projectTitle}". Please ensure the project has a Release field configured.`
                  });
                  continue;
                }

                // Determine the release value based on priority
                let releaseValue;
                if (priorityValue === 'P0' || priorityValue === 'P1') {
                  releaseValue = currentRelease;
                  console.log(`Priority is ${priorityValue}, setting release to ${releaseValue}`);
                } else if (priorityValue.match(/^P[2-9]$/) || priorityValue.match(/^P\d{2,}$/)) {
                  releaseValue = 'Backlog';
                  console.log(`Priority is ${priorityValue} (P2 or higher), setting release to Backlog`);
                } else {
                  console.log(`Unknown priority format: ${priorityValue}, skipping`);
                  continue;
                }

                // Update the Release field
                const updateMutation = `
                  mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: String!) {
                    updateProjectV2ItemFieldValue(
                      input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { text: $value }
                      }
                    ) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;

                await github.graphql(updateMutation, {
                  projectId: projectId,
                  itemId: itemId,
                  fieldId: releaseFieldId,
                  value: releaseValue
                });

                console.log(`Successfully updated Release field to "${releaseValue}" in project "${projectTitle}"`);

                // Add a success comment
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issueNumber,
                  body: `✅ **Release Automation**: Release field automatically set to **${releaseValue}** based on Priority **${priorityValue}** in project "${projectTitle}".`
                });
              }

            } catch (error) {
              console.error('Error updating release field:', error);

              // Add error comment
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: `❌ **Release Automation Error**: Failed to update Release field.\n\n\`\`\`\n${error.message}\n\`\`\`\n\nPlease ensure:\n- The issue is added to a GitHub Project\n- The project has both Priority and Release fields\n- The PROJECT_TOKEN secret has appropriate permissions`
              });
            }
